# Deploy backend to Digital Ocean droplet on push to main.
# Requires repo secrets: DROPLET_IP, DROPLET_SSH_KEY (SSH private key for root@DROPLET_IP).
name: Deploy to Droplet

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Set up SSH key
        run: |
          echo "${{ secrets.DROPLET_SSH_KEY }}" > deploy_key.pem
          chmod 600 deploy_key.pem

      - name: Add droplet to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.DROPLET_IP }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy on droplet
        run: |
          ssh -i deploy_key.pem -o StrictHostKeyChecking=no root@"${{ secrets.DROPLET_IP }}" \
            'cd /opt/fpl-refresh && \
             sudo -u fpl git fetch origin && \
             sudo -u fpl git checkout main && \
             sudo -u fpl git pull origin main && \
             sudo -u fpl /opt/fpl-refresh/venv/bin/pip install -r /opt/fpl-refresh/backend/requirements.txt --quiet && \
             sudo systemctl restart fpl-refresh.service && \
             sudo systemctl status fpl-refresh.service'
